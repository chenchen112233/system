<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>美容皮膚管理顧客系統</title>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  collection,
  getDocs,
  setDoc,
  doc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCpyGKlPjdwi3zBvI2DsRpOaG5UE7s-7tQ",
  authDomain: "system-6e82f.firebaseapp.com",
  projectId: "system-6e82f",
  storageBucket: "system-6e82f.appspot.com",
  messagingSenderId: "435886614335",
  appId: "1:435886614335:web:ca493fc81d8d718208d58a"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// 給下面主程式用
window.db = db;
window.collection = collection;
window.getDocs = getDocs;
window.setDoc = setDoc;
window.doc = doc;
</script>

<style>
/*（你的 CSS 原樣保留，為了不干擾功能我沒有改）*/
:root {
  --bg-color:#F7F4EF;--card-bg:#FFF;--text-main:#5D4037;
  --text-light:#8D6E63;--accent-color:#D7CCC8;--primary-btn:#8D6E63;
}
*{box-sizing:border-box}
body{margin:0;font-family:"PingFang TC","Noto Sans TC",sans-serif;background:var(--bg-color);color:var(--text-main);overflow:hidden}
.view{position:absolute;top:0;left:0;width:100%;height:100%;padding:20px;overflow-y:auto}
.hidden{display:none}
.customer-card{background:#FFF;border-radius:16px;padding:15px;margin-bottom:10px;display:flex;justify-content:space-between;cursor:pointer}
.fab-btn{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:var(--primary-btn);color:#fff;padding:15px 30px;border-radius:50px;border:none}
.record-item{border-left:3px solid var(--accent-color);padding-left:10px;margin-bottom:10px;position:relative}
.delete-record{position:absolute;right:0;top:0;color:red;cursor:pointer}
.toast{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#000;color:#fff;padding:10px 20px;border-radius:8px;display:none}
</style>
</head>

<body>

<div id="home-view" class="view">
  <h2 style="text-align:center">顧客資料管理</h2>
  <input id="searchInput" placeholder="搜尋顧客" oninput="renderList()" style="width:100%;padding:10px">
  <div id="customerList"></div>
  <button class="fab-btn" onclick="openEditor()">＋ 新增顧客</button>
</div>

<div id="editor-view" class="view hidden">
  <button onclick="goHome()">← 返回</button>
  <input id="custName" placeholder="姓名">
  <input id="tel" placeholder="電話">
  <input type="date" id="consultDate">
  <button onclick="saveCustomer()">儲存</button>

  <h3>課程紀錄</h3>
  <input id="recTitle" placeholder="課程名稱">
  <input type="date" id="recDate">
  <input id="recContent" placeholder="內容">
  <button onclick="addRecordItem()">＋ 新增紀錄</button>
  <div id="recordsContainer"></div>
</div>

<div id="toast" class="toast"></div>

<script type="module">
/* ===== DOM ===== */
const homeView = document.getElementById('home-view');
const editorView = document.getElementById('editor-view');
const customerList = document.getElementById('customerList');
const searchInput = document.getElementById('searchInput');
const toast = document.getElementById('toast');

let customers = [];
let currentId = null;

/* ===== Init ===== */
async function init(){
  customers=[];
  const snap = await getDocs(collection(db,"customers"));
  snap.forEach(d=>customers.push(d.data()));
  renderList();
  recDate.value=new Date().toISOString().split('T')[0];
}

/* ===== List ===== */
function renderList(){
  customerList.innerHTML='';
  customers
    .filter(c=>c.name.includes(searchInput.value))
    .sort((a,b)=>b.updatedAt-a.updatedAt)
    .forEach(c=>{
      const div=document.createElement('div');
      div.className='customer-card';
      div.innerHTML=`<div>${c.name}<br>${c.tel||''}</div><div>›</div>`;
      div.onclick=()=>openEditor(c.id);
      customerList.appendChild(div);
    });
}

/* ===== Editor ===== */
function openEditor(id=null){
  homeView.classList.add('hidden');
  editorView.classList.remove('hidden');
  currentId=id;
  clearForm();
  if(id){
    const d=customers.find(c=>c.id===id);
    if(d){
      custName.value=d.name;
      tel.value=d.tel;
      consultDate.value=d.consultDate||'';
      if(d.records) d.records.forEach(r=>renderRecordItem(r));
    }
  }
}

function goHome(){
  editorView.classList.add('hidden');
  homeView.classList.remove('hidden');
  renderList();
}

function clearForm(){
  custName.value='';
  tel.value='';
  consultDate.value='';
  recordsContainer.innerHTML='';
}

/* ===== Records ===== */
function addRecordItem(){
  const r={
    title:recTitle.value,
    date:recDate.value,
    content:recContent.value
  };
  renderRecordItem(r,true);
  recTitle.value='';
  recContent.value='';
}

function renderRecordItem(r,newItem=false){
  const div=document.createElement('div');
  div.className='record-item';
  div.dataset.title=r.title||'';
  div.dataset.date=r.date||'';
  div.dataset.content=r.content||'';
  div.innerHTML=`
    <div class="delete-record" onclick="this.parentElement.remove()">✕</div>
    <b>${r.title}</b><br>${r.date}<br>${r.content}
  `;
  recordsContainer[newItem?'prepend':'append'](div);
}

function getRecords(){
  return [...document.querySelectorAll('.record-item')].map(i=>({
    title:i.dataset.title,
    date:i.dataset.date,
    content:i.dataset.content
  }));
}

/* ===== Save ===== */
async function saveCustomer(){
  if(!custName.value.trim()) return alert('請填姓名');
  const id=currentId||Date.now().toString();
  const data={
    id,
    updatedAt:Date.now(),
    name:custName.value,
    tel:tel.value,
    consultDate:consultDate.value,
    records:getRecords()
  };
  await setDoc(doc(db,"customers",id),data);
  showToast('雲端儲存成功');
  setTimeout(goHome,800);
}

/* ===== UI ===== */
function showToast(msg){
  toast.innerText=msg;
  toast.style.display='block';
  setTimeout(()=>toast.style.display='none',2000);
}

/* expose */
window.openEditor=openEditor;
window.saveCustomer=saveCustomer;
window.renderList=renderList;
window.goHome=goHome;
window.addRecordItem=addRecordItem;

init();
</script>
</body>
</html>
